  We illustrate our theory by deriving a ``non-conservative
entropic force'' in SGD.  We avoid the next section's generality.%and
%
%
%notational complexity.

  %We illustrate the content and methods of our theory by using it in this
  %section to derive a non-conservative entropic force that affects SGD.
  %We sketch a path toward Corollary \ref{cor:entropic} while avoiding the
  %generality and notation of the next section.%\S\ref{sect:calculus}.\squash

\subsection{Notation and assumptions, I}\label{sect:setup}
    %--  the landscape  -----------------------------------------------

  We formalize the loss --- suffered by a fixed architecture on a random
datapoint --- as a distribution $\Dd$ over functions from a space $\Mm$ of
weights.  The \emph{testing loss} $l:\Mm\to\RR$ is $\Dd$'s mean.  We write
$\theta\in\Mm$, $l_x\sim\Dd$ for generic elements.
%
We consider training sequences $(l_n: 0\leq n<N) \sim \Dd^N$.  We call
$n$ and $l_n$ \emph{training points}.
%
Each initialization $\theta_0 \in \Mm$ then induces via SGD a
distribution over trajectories $(\theta_t: 0\leq t \leq T)$.  Specifically,
SGD runs $T$ steps of $\eta$-steepest descent:
  \begin{equation*}
    \textstyle
    \theta_{t+1}^\mu
    \coloneqq
    \theta_t^\mu -
    \sum_{\nu}
    \eta^{\mu\nu} \nabla_\nu l_{n_t}(\theta_t)
  \end{equation*}
Each sequence $(n_t: kN\leq t<kN+N)$ is a permutation of $(n:
0\leq n<N)$.  Our Greek indices name components of
$\theta,\eta,\nabla$ w.r.t.\ a fixed basis.  We view $\eta$
as a bilinear form %, not for generality but
so that the only type-correct expressions have geometric significance.
%

We heavily use the
\textbf{gradient} $G_\mu = \expc[\nb_\mu\lx]$, % \leftrightsquigarrow \sdia{MOO(0)(0)}$,
\textbf{hessian} $H_{\mu\nu} = \expc[\nb_\mu\nb_\nu\lx]$, %  \leftrightsquigarrow \sdia{MOO(0)(0-0)}$,
\textbf{jerk} \squish $J_{\mu\nu\xi} = \expc[\nb_\mu\nb_\nu\nb_\xi\lx]$, %  \leftrightsquigarrow \sdia{MOO(0)(0-0-0)}$,
\textbf{covariance} $C_{\mu\nu} = \expc[(\nb\lx - G)^{\otimes 2}]_{\mu\nu}$, %     \leftrightsquigarrow \sdia{MOOc(01)(0-1)}$, and
and
\textbf{skew} \squash $S_{\mu\nu\xi} = \expc[(\nb\lx - G)^{\otimes 3}]_{\mu\nu\xi}$, %  \leftrightsquigarrow \sdia{MOOc(012)(0-1-2)}$,
typically evaluated at
initialization ($\theta=\theta_0$).
So $G, H, J, C, S$ respectively have $1, 2, 3, 2, 3$ many axes, each of which
transforms under change-of-basis like a covector.\footnote{
    Gradients
    (covectors, dollars-per-mile) and displacements (vectors, miles) have geometrically
    distinct types.  We respect this distinction throughout; that's
    why our $\eta$ is a tensor.
    \cite{mi73} (\S2.5) visualizes this geometry;
    \cite{cu87} (\S1.4) discusses vectors vs covectors in statistics.
}

To illustrate our notation
we quote %a well-known result
\citet{ne04}, \S 2.1:
\begin{prop}\label{prop:nest}
    $G = \nabla l(\theta_0)$ controls the loss to leading order.
    Precisely,
    $
        \expc[l(\theta_T)-l(\theta_0)]^\mu =
        - 
        T \sum_{\mu\nu} G_\mu \eta^{\mu\nu} G_\nu
        + o(\eta^1)
    $.
\end{prop}
%For noiseless linear landscapes (when $\nabla l_x(\theta)$
%depends on neither $x$ nor $\theta$), this estimate is exact.
%
\noindent
Our work identifies how noise and curvature correct Prop
\ref{prop:nest}.%by developing 
%large-$T$
%techniques less
%opaque and more convergent than induction.
%


\subsection{SGD descends on a $C$-smoothed landscape}\label{sect:entropic-curl}
%An entropic force with curl}

Let's study the displacement $\expc[\theta_T-\theta_0]$ of one-epoch,
batch-size-one SGD initialized at a testing loss minimum.

We sketched above how a sum over diagrams gives 
$\expc[l(\theta_T)]$ for the testing loss $l$.  We may likewise compute
$\expc[s(\theta_T)]$ for other $s:\Mm\to\RR$; we need only replace the factor
$\expc[\nabla^k l(\theta_0)]$ corresponding to each diagram's root by
the factor $\expc[\nabla^k s(\theta_0)]$.
%
Specifically, a linear
$s(\theta)=w\cdot \theta$ reveals the displacement's $w$-component. 
%
Since $s$'s higher derivatives vanish, any diagram whose root has
degree $>1$ will evaluate to zero.  So 
only diagrams with degree-$1$ root are relevant to computing
displacements (e.g.\ $\sdia{c(0-1)(01)}, \sdia{c(0-1-2)(01-12)}, \sdia{c(01-2-3)(02-12-23)}$).

Because in this example we initialize at a minimum ($G=0$), 
we may ignore yet more diagrams: those with a factor of $\expc[\nabla l]$, i.e.,
those with a degree-$1$ non-root node that's not fuzzily grouped.
So we rule out $\sdia{c(0-1)(01)}, \sdia{c(0-1-2)(01-12)}, \cdots$.
%
%It turns out that
Only one fewest-edged diagram remains:
$\sdia{c(01-2-3)(02-12-23)}$, which evaluates to
$\expc[\nabla l\nabla l](-\eta)^2\expc[\nabla\nabla \nabla l](-\eta)\expc[\nabla s]=-\eta^3 (C\nabla H)\cdot (\nabla s)$.
%
So to leading order the displacement is some time-dependent number of histories times $-\eta^3 (C\nabla H)$.
%%/2!$ to leading order.\footnote{%
%%    The $2!$ comes 
%%    ``symmetry factors'' that we ignore for now. 
%%}

\begin{figure}%{r}{0.3\textwidth}
    \centering
    \crunch\squash
    \plotmoow{aaai/cubic}{0.28\textwidth}{}
    \rotatebox[origin=c]{-90}{\plotmoow{plots/from-above}{0.17\textwidth}{}}
    \caption{%
        \textbf{Left}:
        Gradient noise pushes SGD toward minima flat w.r.t.\ $C$.
            A 2D loss near
            a valley of minima.  Red densities show typical
            $\theta$s, perturbed by noise ($C$),
            in two cross sections of the valley.  The hessian
            changes across the valley: $J \neq 0$.  
        \textbf{Right}: \Helix\ is defined on an $\Mm=\RR^3$ 
        extending into the page.  A helical
        level surface $S$ (orange-green) of $l$ winds around 
        a 1D valley of minima orthogonal to the
        page.  $l$ $\gg$ $1$ outside $S$.  Gradient noise
        is parallel to the page and to the line between outer tubes.
        %
        Thanks to
        \href{https://www.monroecc.edu/faculty/paulseeburger/calcnsf/CalcPlot3D/}{CalcPlot3D}.
    }
    \label{fig:cubic}
    \crunch
\end{figure}
Since $-\eta^3 C\nabla H$ points toward small $H$, \textbf{SGD moves
toward flat minima} (Figure \ref{fig:cubic}).
This effect scales with $C$.  
%
%%The bilinear form
%%$F^{\mu\nu}=\textstyle\sum_{\xi\omicron}\eta^{\mu\xi}
%%\eta^{\nu\omicron} C_{\xi\omicron}$ determines which $H$s
%%are `sharp' or `flat'.  E.g.: if $F$
%%degenerates along a covector $v$, then $H$'s 
%%$v$-component does not affect $\expc[\theta_T-\theta_0]$
%\footnote{
%    Explicitly: if
%        $\sum_{\mu\nu} v_\mu F^{\mu\nu} v_\nu = 0$,
%    then replacing $H$ by $\tilde H_{\mu\nu} = H_{\mu\nu} + 42 v_\mu v_\nu$ 
%    will not change $\Delta_\circ$.
%}
%
%Diagram techniques establish
Re-summation more precisely quantifies this `entropic force':\footnote{
    Thermal systems tend toward disorder as if pushed by an
    `entropic force'.
    So arises the tension of rubber
    bands: their polymers can wreathe in
    many ways but be straight in only one.
    Such `forces' characteristically 
    scale with
    temperature (the noise intensity $C$).
}\footnote{
    Our result ($T\gg 1$) is $\Theta(\eta^2)$; \cite{ya19b}'s
    ($T=2$) is $\Theta(\eta^3)$.  We
    integrate noise over time, amplifying $C$'s
    effect. 
}
%%as dominant when $G=0$, $N=T$.
%%Evaluating a single diagram
%%($
%%    \sdia{c(01-2-3)(02-12-23)}
%%$) yields:
%
\begin{cor}\label{cor:entropic}%[Computed from $\sdia{c(01-2-3)(02-12-23)}$]
    Start SGD at a minimum of $l$ with $H>0$, $N=T$.  Use
    an eigenbasis of $K=\eta H$.  
    For any $T$ and
    with ${\mathcal P}_T(s) = (1 - \exp(-Ts))/s$,
    the 
    expected displacement is
    %final displacement
    %    $M_1^\xi$
    %is
    $$
        -
        {\textstyle\sum_{\substack{\mu\nu    \\ \omicron\pi\rho}}}
            C_{\mu\omicron}
            {\color{gray}{\mathcal P}_T(K_{\mu\mu} + K_{\omicron\omicron})}
            \eta^{\mu\nu}\eta^{\omicron\pi}
            J_{\nu\pi\xi}
            {\color{gray}{\mathcal P}_T(K_{\xi\xi})}\eta^{\xi\rho}/2
        + o(\eta^3)
        \squish\squish
    $$
\end{cor}

Consider a 1D valley of near-minima wherein $\eta H$ has spectrum
$\lambda_0 \ll 1/T \ll \lambda_1 \leq \cdots$ for eigenvectors
$v_i$.  Let's ignore diffusion along the valley: $(\eta C) v_0 =
0$.
%
Then ${\mathcal P}_T(\lambda_0)\approx T$ and every
$C_{ij}{\mathcal P}_T(\lambda_i+\lambda_j)$ is $O(T^0)$.  So $\expc[\theta_T-\theta_0]$
scales linearly with $T$.  We thus expect SGD to move with
%velocity $-f(\eta,H,T)\cdot C\nabla H/2$ toward flat minima.  
velocity $\approx -\eta^2 C\nabla H/2$ per timestep toward flat minima.  
Observe that $\nabla ({\frak G}_C \star l) = \nabla l+C\nabla
H/2 + o(C)$, where ${\frak G}_C \star$ denotes convolution with a
\emph{fixed} centered $C$-shaped Gaussian; we conclude with the
intuition that \emph{SGD descends on a $C$-smoothed landscape that
changes as $C$ does}.  %Since the smoothed $l$ may itself evolve,
%SGD might eternally circulate.

%\subsection{Curl in the entropic force}
\begin{figure}[h!]
    \plotmoow{aaai/screw-trajectory-cropped}{0.47\textwidth}{} 
    \squash
    \caption{%
        %
        Green: SGD's trajectory over 
        cross sections of \Helix\ descend progressively
        into the page.  Blue: $l$'s contours; $l$'s valley
        intersects each pane's center.  Dotted
        curves help compare adjacent panes.
        Red: %bi-arrows:
        $C$'s
        major axis.
        %
        Gradient noise kicks $\theta$ from A; $\theta$ then falls
        (\hspace{-0.12cm}\protect\offour{1}) to B in {\hspace{-0.08cm}\protect\offour{2}}.  At C,
        noise kicks $\theta$ uphill (\hspace{-0.08cm}\protect\offour{3}); $\theta$
        thus never settles and the descent persists.
    }
    \squash\squash
    \label{fig:archimedes}
\end{figure}

To test Corollary \ref{cor:entropic}'s $C$-dependence,
we %\S\ref{appendix:artificial}
construct a landscape, \Helix, on
whose valley of global minima $C$ varies (Figure
\ref{fig:archimedes}).  As in Rock-Paper-Scissors, each 
$\theta$ has a neighbor that is more attractive (flatter) w.r.t.\
$C(\theta)$.  This induces eternal motion into the page
despite \Helix's discrete translation symmetry.
%in that direction.
Corollary \ref{cor:entropic} predicts a velocity of
$+\eta^2/6$ per timestep, while \cite{ch18}'s SDE-based analysis
predicts a constant velocity of $0$.\footnote{
    For, \Helix' velocity is $\eta$-perpendicular to the image
    of $(\eta C)^\mu_\nu$.%in tangent space.
}
%One may add a small linear term to \Helix\ to make SGD eternally
%ascend;
Wrapping \Helix\ in a loop makes SGD circulate. %in
%a velocity field with curl. %(\S\ref{appendix:artificial});
This is
possible because $C\nabla H$, unlike $\nabla(CH)$, is not a total
derivative. 
In avoiding \cite{we19b}'s constant-$C$ assumption, we 
find that SGD's velocity field can have curl. 

